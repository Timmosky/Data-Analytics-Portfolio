
Combined_Anomaly_Category = 
VAR Exceedance8Week = [Exceedance_8Week]
VAR ExceedanceQuarterly = [Exceedance_Quarterly]
VAR CurrentQuarter = [Current_Quarter_Number]
VAR TriggerQuarter = [First_8Week_Trigger_Quarter]

/* Calculate if we're in valid range (0-2 quarters from trigger) */
VAR Had8WeekTrigger = NOT ISBLANK( TriggerQuarter )
VAR QuarterDistance = CurrentQuarter - TriggerQuarter
VAR IsWithinValidRange = Had8WeekTrigger && QuarterDistance >= 0 && QuarterDistance <= 2

/* Check if in trigger quarter specifically */
VAR IsInTriggerQuarter = CurrentQuarter = TriggerQuarter

RETURN
SWITCH(
    TRUE(),
    /* PRIORITY 1: In trigger quarter with 8-week spike → Initial Anomaly */
    IsInTriggerQuarter && Exceedance8Week >= 2, 
        "Anomaly Detected",
    
    /* PRIORITY 2: Quarterly ≥2 AND within valid range (0-2 quarters) → Sustained */
    ExceedanceQuarterly >= 2 && IsWithinValidRange, 
        "Sustained Anomaly Detected",
    
    /* PRIORITY 3: 8-week spike outside trigger quarter */
    Exceedance8Week >= 2, 
        "Anomaly Detected",
    
    /* PRIORITY 4: Quarterly ≥2 but OUTSIDE valid range (3+ quarters or no trigger) */
    ExceedanceQuarterly >= 2, 
        "Quarterly Anomaly (Out of Range)",
    
    /* PRIORITY 5: Individual spikes */
    [TrailingAnomaly] = 1 OR [Quarterly_YoY_Anomaly] = 1, 
        "Single Spike",
    
    /* PRIORITY 6: Normal */
    "Normal"
)
--------------------------
Combined_Anomaly_Category_Detailed = 
VAR Exceedance8Week = [Exceedance_8Week]
VAR ExceedanceQuarterly = [Exceedance_Quarterly]
VAR IsSustainedValid = [Is_Sustained_Anomaly_Valid]
VAR CurrentQuarter = [Current_Quarter_Number]
VAR TriggerQuarter = [First_8Week_Trigger_Quarter]
VAR IsInTriggerQuarter = CurrentQuarter = TriggerQuarter

RETURN
SWITCH(
    TRUE(),
    /* In trigger quarter with 8-week spike */
    IsInTriggerQuarter && Exceedance8Week >= 2, 
        "Anomaly Detected (Initial Trigger)",
    
    /* In trigger quarter with quarterly consecutive but no 8-week */
    IsInTriggerQuarter && ExceedanceQuarterly >= 2,
        "Sustained Anomaly Detected (Same Quarter)",
    
    /* After trigger quarter within valid range */
    ExceedanceQuarterly >= 2 && IsSustainedValid = 1 && NOT IsInTriggerQuarter,
        "Sustained Anomaly Detected",
    
    /* 8-week anomaly outside trigger quarter */
    Exceedance8Week >= 2,
        "Anomaly Detected",
    
    /* Quarterly anomaly outside valid range */
    ExceedanceQuarterly >= 2,
        "Quarterly Anomaly (Out of Range)",
    
    /* Single spikes */
    [TrailingAnomaly] = 1 OR [Quarterly_YoY_Anomaly] = 1,
        "Single Spike",
    
    "Normal"
)
--------------------------------------------------------------------------------
Combined_Anomaly_Category = 
VAR Exceedance8Week = [Exceedance_8Week]
VAR ExceedanceQuarterly = [Exceedance_Quarterly]
VAR IsSustainedValid = [Is_Sustained_Anomaly_Valid]

RETURN
SWITCH(
    TRUE(),
    /* PRIORITY 1: Sustained Anomaly - must check FIRST */
    ExceedanceQuarterly >= 2 && IsSustainedValid = 1, "Sustained Anomaly Detected",
    
    /* PRIORITY 2: Both methods detect consecutive anomalies but NOT valid for sustained */
    Exceedance8Week >= 2 && ExceedanceQuarterly >= 2, "Both Methods - Out of Range",
    
    /* PRIORITY 3: 8-week consecutive anomaly only */
    Exceedance8Week >= 2, "Anomaly Detected",
    
    /* PRIORITY 4: Quarterly consecutive anomaly but outside valid range */
    ExceedanceQuarterly >= 2, "Quarterly Anomaly (Out of Range)",
    
    /* PRIORITY 5: Individual anomalies but not consecutive */
    [TrailingAnomaly] = 1 OR [Quarterly_YoY_Anomaly] = 1, "Single Spike",
    
    /* PRIORITY 6: Normal */
    "Normal"
)







-----------------------------------------------------

First_8Week_Trigger_Quarter_Rolling = 
VAR CurrentItem = MAX( parts[Item Description] )
VAR CurrentYear = [Current_Year]
VAR CurrentFiscalWeek = MAX( parts[Order Fiscal Week] )

/* Summarize weeks with their exceedance values */
VAR WeeksSummary = 
    SUMMARIZE(
        FILTER(
            parts,
            parts[Item Description] = CurrentItem
            && INT( parts[Order Fiscal Week] / 100 ) = CurrentYear
            && parts[Order Fiscal Week] <= CurrentFiscalWeek
        ),
        parts[Order Fiscal Week]
    )

/* Add exceedance calculation */
VAR WeeksWithExceedance = 
    ADDCOLUMNS(
        WeeksSummary,
        "@Exceedance", [Exceedance_8Week]
    )

/* Filter to trigger weeks */
VAR TriggerWeeks = 
    FILTER(
        WeeksWithExceedance,
        [@Exceedance] >= 2
    )

/* Get the most recent trigger week */
VAR MostRecentTriggerWeek = 
    MAXX( TriggerWeeks, parts[Order Fiscal Week] )

/* Extract week number */
VAR TriggerWeekNum = MOD( MostRecentTriggerWeek, 100 )

/* Determine quarter */
VAR TriggerQuarter = 
    SWITCH(
        TRUE(),
        TriggerWeekNum >= 1 && TriggerWeekNum <= 13, 1,
        TriggerWeekNum >= 14 && TriggerWeekNum <= 26, 2,
        TriggerWeekNum >= 27 && TriggerWeekNum <= 39, 3,
        TriggerWeekNum >= 40 && TriggerWeekNum <= 53, 4,
        BLANK()
    )

RETURN TriggerQuarter




-----Step 1------------------

Current_Quarter_Number = 
VAR FiscalWeek = MAX( parts[Order Fiscal Week] )
VAR WeekNum = VALUE( RIGHT( FORMAT( FiscalWeek, "0" ), 2 ) )

VAR QuarterNum = 
    SWITCH(
        TRUE(),
        WeekNum >= 1 && WeekNum <= 13, 1,
        WeekNum >= 14 && WeekNum <= 26, 2,
        WeekNum >= 27 && WeekNum <= 39, 3,
        WeekNum >= 40 && WeekNum <= 53, 4,
        BLANK()
    )

RETURN QuarterNum


-----------------Step 2--------------
Current_Year = 
VAR FiscalWeek = MAX( parts[Order Fiscal Week] )
VAR Year = VALUE( LEFT( FORMAT( FiscalWeek, "0" ), 4 ) )

RETURN Year

---------------------step 3------------------

First_8Week_Trigger_Quarter_Rolling = 
VAR CurrentItem = MAX( parts[Item Description] )
VAR CurrentYear = [Current_Year]
VAR CurrentFiscalWeek = MAX( parts[Order Fiscal Week] )

/* Find the most recent week (up to current) where 8-week exceedance >= 2 */
VAR MostRecentTriggerWeek = 
    CALCULATE(
        MAX( parts[Order Fiscal Week] ),
        parts[Item Description] = CurrentItem,
        parts[Order Fiscal Week] <= CurrentFiscalWeek,
        [Current_Year] = CurrentYear,
        [Exceedance_8Week] >= 2
    )

/* Extract quarter from that week */
VAR TriggerWeekNum = VALUE( RIGHT( FORMAT( MostRecentTriggerWeek, "0" ), 2 ) )

VAR TriggerQuarter = 
    SWITCH(
        TRUE(),
        TriggerWeekNum >= 1 && TriggerWeekNum <= 13, 1,
        TriggerWeekNum >= 14 && TriggerWeekNum <= 26, 2,
        TriggerWeekNum >= 27 && TriggerWeekNum <= 39, 3,
        TriggerWeekNum >= 40 && TriggerWeekNum <= 53, 4,
        BLANK()
    )

RETURN TriggerQuarter

----------step 4----------------------

Is_Sustained_Anomaly_Valid = 
VAR CurrentQuarter = [Current_Quarter_Number]
VAR FirstTriggerQuarter = [First_8Week_Trigger_Quarter]

/* Check if there was an 8-week trigger this year */
VAR Had8WeekTrigger = NOT ISBLANK( FirstTriggerQuarter )

/* Check if current quarter is within 1 quarter of the trigger */
VAR QuarterDistance = ABS( CurrentQuarter - FirstTriggerQuarter )
VAR IsWithinRange = QuarterDistance <= 1

RETURN
IF( Had8WeekTrigger && IsWithinRange, TRUE(), FALSE() )



------------------------------step 5--------------------------

Combined_Anomaly_Category = 
VAR Exceedance8Week = [Exceedance_8Week]
VAR ExceedanceQuarterly = [Exceedance_Quarterly]
VAR IsSustainedValid = [Is_Sustained_Anomaly_Valid]

RETURN
SWITCH(
    TRUE(),
    /* Sustained Anomaly: Quarterly ≥2 AND valid based on 8-week trigger */
    ExceedanceQuarterly >= 2 && IsSustainedValid = TRUE(), "Sustained Anomaly Detected",
    
    /* Regular Anomaly: 8-week ≥2 */
    Exceedance8Week >= 2, "Anomaly Detected",
    
    /* Individual anomalies but not consecutive */
    [TrailingAnomaly] = 1 OR [Quarterly_YoY_Anomaly] = 1, "Single Spike",
    
    /* Normal */
    "Normal"
)

----------------------------step 6----------------------------
Combined_Anomaly_Severity = 
VAR Category = [Combined_Anomaly_Category]

RETURN
SWITCH(
    Category,
    "Sustained Anomaly Detected", 3,  -- Critical
    "Anomaly Detected", 2,            -- Warning
    "Single Spike", 1,                 -- Info
    0                                  -- Normal
)


------------step 7------------------------
Anomaly_Flag_Details = 
VAR Category = [Combined_Anomaly_Category]
VAR Exceedance8Week = [Exceedance_8Week]
VAR ExceedanceQuarterly = [Exceedance_Quarterly]
VAR CurrentQuarter = "Q" & [Current_Quarter_Number]
VAR TriggerQuarter = 
    IF( 
        NOT ISBLANK([First_8Week_Trigger_Quarter]), 
        "Q" & [First_8Week_Trigger_Quarter], 
        "None" 
    )

RETURN
IF(
    Category <> "Normal",
    Category & 
    " | 8W: " & IF( ISBLANK(Exceedance8Week), "0", FORMAT(Exceedance8Week, "0") ) & 
    " | Q: " & IF( ISBLANK(ExceedanceQuarterly), "0", FORMAT(ExceedanceQuarterly, "0") ) &
    " | Current: " & CurrentQuarter &
    " | Trigger: " & TriggerQuarter,
    "Normal"
)


First_8Week_Trigger_Quarter_Rolling = 
VAR CurrentItem = MAX( parts[Item Description] )
VAR CurrentYear = [Current_Year]
VAR CurrentFiscalWeek = MAX( parts[Order Fiscal Week] )

/* Find the most recent week where exceedance >= 2 */
VAR MostRecentTriggerWeek = 
    MAXX(
        FILTER(
            CALCULATETABLE(
                parts,
                parts[Item Description] = CurrentItem,
                parts[Order Fiscal Week] <= CurrentFiscalWeek
            ),
            VAR WeekContext = parts[Order Fiscal Week]
            VAR YearContext = VALUE( LEFT( FORMAT( WeekContext, "0" ), 4 ) )
            VAR ExceedanceValue = 
                CALCULATE(
                    [Exceedance_8Week],
                    parts[Order Fiscal Week] = WeekContext
                )
            RETURN YearContext = CurrentYear && ExceedanceValue >= 2
        ),
        parts[Order Fiscal Week]
    )

/* Extract quarter from that week */
VAR TriggerWeekNum = VALUE( RIGHT( FORMAT( MostRecentTriggerWeek, "0" ), 2 ) )

VAR TriggerQuarter = 
    SWITCH(
        TRUE(),
        TriggerWeekNum >= 1 && TriggerWeekNum <= 13, 1,
        TriggerWeekNum >= 14 && TriggerWeekNum <= 26, 2,
        TriggerWeekNum >= 27 && TriggerWeekNum <= 39, 3,
        TriggerWeekNum >= 40 && TriggerWeekNum <= 53, 4,
        BLANK()
    )

RETURN TriggerQuarter

--------------------------------------------
Exceedance_pp_YOY_ = 
var currentweek = MAX(parts[Order Fiscal Week])
VAR currentitem = MAX(parts[Item Description]) 
VAR current_family = MAX(parts[Ultimate_family_name])
Var threshold = SELECTEDVALUE('Exceedance Period'[WeeksAbove],1)
var Maxlookback = 52
Var offsets = GENERATESERIES(0, Maxlookback, 1)

var firstzerooffset = MINX(offsets, Var o = [Value] 

VAR wkDate = currentweek - o 
VAR f1 = MAXX(FILTER(ALL(parts[Item Description], parts[Ultimate_family_name], parts[Order Fiscal Week]), parts[Item Description] = currentitem && parts[Ultimate_family_name] = current_family && parts[Order Fiscal Week] = wkDate),parts[Exceedance_Flag_YOY])


RETURN IF(COALESCE( f1, 0) = 0, o, BLANK()))

var streak = IF(ISBLANK(firstzerooffset), Maxlookback + 1 , firstzerooffset)

RETURN
IF(streak >= threshold, streak, BLANK())

--------------
Exceedance_pp = 
var currentweek = MAX(parts[Order Fiscal Week])
VAR currentitem = MAX(parts[Item Description]) 
VAR current_family = MAX(parts[Ultimate_family_name])
Var threshold = SELECTEDVALUE('Exceedance Period'[WeeksAbove],1)
var Maxlookback = 52
Var offsets = GENERATESERIES(0, Maxlookback, 1)

var firstzerooffset = MINX(offsets, Var o = [Value] 

VAR wkDate = currentweek - o 
VAR f1 = MAXX(FILTER(ALL(parts[Item Description], parts[Ultimate_family_name], parts[Order Fiscal Week]), parts[Item Description] = currentitem && parts[Ultimate_family_name] = current_family && parts[Order Fiscal Week] = wkDate),parts[Exceedance_Flag])


RETURN IF(COALESCE( f1, 0) = 0, o, BLANK()))

var streak = IF(ISBLANK(firstzerooffset), Maxlookback + 1 , firstzerooffset)

RETURN
IF(streak >= threshold, streak, BLANK())


----------------------------------------
First_8Week_Trigger_Quarter_Rolling = 
VAR CurrentItem = MAX( parts[Item Description] )
VAR CurrentYear = [Current_Year]
VAR CurrentFiscalWeek = MAX( parts[Order Fiscal Week] )

/* Get all weeks up to (and including) current week */
VAR WeeksUpToCurrent = 
    CALCULATETABLE(
        VALUES( parts[Order Fiscal Week] ),
        parts[Item Description] = CurrentItem,
        INT( parts[Order Fiscal Week] / 100 ) = CurrentYear,
        parts[Order Fiscal Week] <= CurrentFiscalWeek  /* KEY: Only weeks up to current */
    )

/* Add exceedance for each week */
VAR WeeksWithExceedance = 
    ADDCOLUMNS(
        WeeksUpToCurrent,
        "@FiscalWeek", parts[Order Fiscal Week],
        "@Exceedance", 
            VAR WeekContext = parts[Order Fiscal Week]
            RETURN
            CALCULATE(
                [Exceedance_8Week],
                parts[Order Fiscal Week] = WeekContext,
                parts[Item Description] = CurrentItem
            )
    )

/* Filter to trigger weeks (exceedance ≥ 2) */
VAR TriggerWeeks = 
    FILTER(
        WeeksWithExceedance,
        [@Exceedance] >= 2
    )

/* Get MOST RECENT trigger week (MAXX = maximum/latest) */
VAR MostRecentTriggerWeek = MAXX( TriggerWeeks, [@FiscalWeek] )

/* Extract quarter from that week */
VAR TriggerWeekNum = MOD( MostRecentTriggerWeek, 100 )

VAR TriggerQuarter = 
    SWITCH(
        TRUE(),
        TriggerWeekNum >= 1 && TriggerWeekNum <= 13, 1,
        TriggerWeekNum >= 14 && TriggerWeekNum <= 26, 2,
        TriggerWeekNum >= 27 && TriggerWeekNum <= 39, 3,
        TriggerWeekNum >= 40 && TriggerWeekNum <= 53, 4,
        BLANK()
    )

RETURN TriggerQuarter


-----------------------------------------------------------------------
WeeklyHealthSummarytable = ADDCOLUMNS(SUMMARIZE(FILTER( Weekly_System_Health, NOT ISBLANK( Weekly_System_Health[Cell_imbalance_health]) || NOT ISBLANK( Weekly_System_Health[Capacity_loss_health]) || NOT
ISBLANK(Weekly_System_Health[Temperature_health]|| NOT ISBLANK(Weekly_System_Health[Cycle_count_health]))), Weekly_System_Health[SystemID], Weekly_System_Health[YearWeek], Weekly_System_Health[Year_week]), "WeekHealth", VAR ThisSystemWeek = FILTER(Weekly_System_Health, Weekly_System_Health[SystemID] = EARLIER([SystemID]) && Weekly_System_Health[YearWeek] = EARLIER([YearWeek]) && Weekly_System_Health[Year_week] = EARLIER([Year_week]))
VAR HasUnhealthy = COUNTROWS(FILTER(ThisSystemWeek,Weekly_System_Health[Cell_imbalance_health] = "Unhealthy" || Weekly_System_Health[Capacity_loss_health] = "Unhealthy" || Weekly_System_Health[Temperature_health] = "Unhealthy" || Weekly_System_Health[Cycle_count_health] = "Deteriorated")) >0
VAR Haswarning = COUNTROWS(FILTER(ThisSystemWeek, Weekly_System_Health[Cell_imbalance_health] = "Warning" || Weekly_System_Health[Capacity_loss_health] = "Warning" || Weekly_System_Health[Temperature_health] = "Warning"|| Weekly_System_Health[Cycle_count_health] = "Warning")) >0
RETURN
SWITCH(TRUE(), HasUnhealthy, "Unhealthy", Haswarning, "Warning", "Stable"))



------------------------------
Unhealthy_systems = CALCULATE([Total Systems (Weekly)], WeeklyHealthSummarytable[WeekHealth] = "Unhealthy")
---------------------------------------------------------------------

AnomalyEvents = 
VAR currentweek = MAX(Weekly_System_Health[WeekofYear])
RETURN
SUMMARIZE(
    FILTER(Weekly_System_Health, [Capacity_loss_health] = "Unhealthy" || [Cell_imbalance_health] = "Unhealthy" || [Cycle_count_health] = "Deteriorated" || [Temperature_health] = "Unhealthy" && Weekly_System_Health[WeekofYear] = currentweek), Weekly_System_Health[SystemID], Weekly_System_Health[Family_type],Weekly_System_Health[Month], Weekly_System_Health[Error_revealed_calc], Weekly_System_Health[Latest_week], Weekly_System_Health[Year_week], Weekly_System_Health[Software_version], Weekly_System_Health[Battery_type], Weekly_System_Health[Year_of_week])


Distinctcount = VAR system = SELECTEDVALUE(AnomalyEvents[SystemID])
RETURN
CALCULATE(COUNTROWS(AnomalyEvents), ALLEXCEPT(AnomalyEvents, AnomalyEvents[Year_of_week]))




--------------------------------------------------------

The Solution: Aggregate Before Calculating Anomalies
Since your anomaly detection should work at the week/item/family level (not individual transaction rows), you need to:

Either aggregate your data first into a clean week-level table
Or modify your formulas to work at the aggregated level


Best Solution: Create Week-Level Aggregated Columns
Instead of calculated columns that operate row-by-row, create columns that aggregate first, then calculate.
Replace Your Current Columns With These:

Column 1: Normal_Rate (Aggregated)
daxNormal_Rate_Aggregated = 
VAR CurrentWeek = parts[Order Fiscal Week]
VAR CurrentItem = parts[Item Description]
VAR CurrentFamily = parts[Ultimate_family_name]

/* Get total quantity for this week/item/family */
VAR TotalQty = 
    CALCULATE(
        SUM(parts[Quantity]),
        parts[Order Fiscal Week] = CurrentWeek,
        parts[Item Description] = CurrentItem,
        parts[Ultimate_family_name] = CurrentFamily,
        ALLEXCEPT(parts, parts[Order Fiscal Week], parts[Item Description], parts[Ultimate_family_name])
    )

/* Get system count for this week/item/family */
VAR SysCount = 
    CALCULATE(
        AVERAGE(parts[System_Count_Column]),
        parts[Order Fiscal Week] = CurrentWeek,
        parts[Item Description] = CurrentItem,
        parts[Ultimate_family_name] = CurrentFamily,
        ALLEXCEPT(parts, parts[Order Fiscal Week], parts[Item Description], parts[Ultimate_family_name])
    )

RETURN
DIVIDE(TotalQty, SysCount, 0)
Wait - this won't work in a calculated column either because of CALCULATE restrictions!

Real Solution: You Need a Separate Aggregated Table
Since calculated columns can't use CALCULATE properly, and your data has multiple rows per week, you must create an aggregated table first.
Step 1: Create Aggregated Table (Do This First!)
Go to Modeling → New Table and create:
daxparts_WeekLevel = 
ADDCOLUMNS(
    SUMMARIZE(
        parts,
        parts[Order Fiscal Week],
        parts[Item Description],
        parts[Ultimate_family_name],
        parts[Order Year],
        parts[numericquarter]
    ),
    "Quantity", 
        VAR CurWeek = [Order Fiscal Week]
        VAR CurItem = [Item Description]
        VAR CurFamily = [Ultimate_family_name]
        RETURN
        CALCULATE(
            SUM(parts[Quantity]),
            parts[Order Fiscal Week] = CurWeek,
            parts[Item Description] = CurItem,
            parts[Ultimate_family_name] = CurFamily
        ),
    
    "System_Count",
        VAR CurWeek = [Order Fiscal Week]
        VAR CurItem = [Item Description]
        VAR CurFamily = [Ultimate_family_name]
        RETURN
        CALCULATE(
            AVERAGE(parts[System_Count_Column]),
            parts[Order Fiscal Week] = CurWeek,
            parts[Item Description] = CurItem,
            parts[Ultimate_family_name] = CurFamily
        ),
    
    "Order_Date_Max",
        VAR CurWeek = [Order Fiscal Week]
        VAR CurItem = [Item Description]
        VAR CurFamily = [Ultimate_family_name]
        RETURN
        CALCULATE(
            MAX(parts[Order Date]),
            parts[Order Fiscal Week] = CurWeek,
            parts[Item Description] = CurItem,
            parts[Ultimate_family_name] = CurFamily
        )
)

Step 2: Add Calculated Columns to parts_WeekLevel Table
Now add all your anomaly detection columns to the parts_WeekLevel table:
Column 1: Normal_Rate
daxNormal_Rate = 
DIVIDE(parts_WeekLevel[Quantity], parts_WeekLevel[System_Count], 0)
Column 2: TrailingUpperLimit
daxTrailingUpperLimit = 
VAR LookbackWeeks = 8
VAR Multiplier = 1.5

VAR CurrentWeek = parts_WeekLevel[Order Fiscal Week]
VAR CurrentItem = parts_WeekLevel[Item Description]
VAR CurrentFamily = parts_WeekLevel[Ultimate_family_name]
VAR CurrentMaxDate = parts_WeekLevel[Order_Date_Max]

VAR StartDate = CurrentMaxDate - (LookbackWeeks * 7)
VAR EndDate = CurrentMaxDate - 1

VAR PriorWeeksData = 
    FILTER(
        parts_WeekLevel,
        parts_WeekLevel[Item Description] = CurrentItem
        && parts_WeekLevel[Ultimate_family_name] = CurrentFamily
        && parts_WeekLevel[Order_Date_Max] >= StartDate
        && parts_WeekLevel[Order_Date_Max] <= EndDate
        && parts_WeekLevel[Order Fiscal Week] <> CurrentWeek
        && NOT ISBLANK(parts_WeekLevel[Normal_Rate])
    )

VAR Mean = AVERAGEX(PriorWeeksData, parts_WeekLevel[Normal_Rate])
VAR StdDev = STDEVX.P(PriorWeeksData, parts_WeekLevel[Normal_Rate])
VAR SafeStdDev = IF(ISBLANK(StdDev) || StdDev = 0, Mean * 0.3, StdDev)

RETURN
IF(NOT ISBLANK(Mean), Mean + (Multiplier * SafeStdDev), BLANK())
Column 3: TrailingAnomaly
daxTrailingAnomaly = 
IF(
    NOT ISBLANK(parts_WeekLevel[TrailingUpperLimit]) 
    && parts_WeekLevel[Normal_Rate] > parts_WeekLevel[TrailingUpperLimit],
    1,
    0
)
------------------------------second trial----------------------------------------
WeekSeq =
RANKX(
    FILTER(
        parts,
        parts[Item Description] = EARLIER(parts[Item Description]) &&
        parts[Ultimate_family_name] = EARLIER(parts[Ultimate_family_name])
    ),
    parts[Order Fiscal Week],
    ,
    ASC,
    DENSE
)
----------------------------------------------------------------------------
Exceedance_Streak =
VAR CurrItem   = parts[Item Description]
VAR CurrFamily = parts[Ultimate_family_name]
VAR CurrSeq    = parts[WeekSeq]

-- Find the last week BEFORE this one where flag = 0
VAR LastZeroSeq =
    MAXX(
        FILTER(
            parts,
            parts[Item Description] = CurrItem &&
            parts[Ultimate_family_name] = CurrFamily &&
            parts[WeekSeq] < CurrSeq &&
            parts[Exceedance_Flag] = 0
        ),
        parts[WeekSeq]
    )

-- Count flagged rows since that reset point
VAR Streak =
    COUNTROWS(
        FILTER(
            parts,
            parts[Item Description] = CurrItem &&
            parts[Ultimate_family_name] = CurrFamily &&
            parts[WeekSeq] > COALESCE(LastZeroSeq, 0) &&
            parts[WeekSeq] <= CurrSeq &&
            parts[Exceedance_Flag] = 1
        )
    )

RETURN
IF(parts[Exceedance_Flag] = 1, Streak, 0)
------------------------------------------------------------------------
Exceedance_pp :=
VAR Threshold = SELECTEDVALUE('Exceedance Period'[Exceedance Period], 1)
RETURN
IF(parts[Exceedance_Streak] >= Threshold, parts[Exceedance_Streak], BLANK())
