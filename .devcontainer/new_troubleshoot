TrailingUpperLimit = 
VAR SelectedMeanWeeks = SELECTEDVALUE( ALERTWINDOWSELECTOR[TrailingWindow], 8 )
VAR SelectedStdWeeks  = SELECTEDVALUE( 'STDDEVIATION SELECTOR'[TrailingWindow], SelectedMeanWeeks )
VAR Multiplier = SELECTEDVALUE( StdDevSelector[Multiplier], 2 )

/* Current week's date - find the max date in current row context */
VAR CurrentWeek = SELECTEDVALUE(parts[Order Fiscal Week])
VAR CurrentMaxDate = 
    CALCULATE(
        MAX(parts[Order Date]),
        parts[Order Fiscal Week] = CurrentWeek,
        ALLEXCEPT(parts, parts[Item Description], parts[Ultimate_family_name])
    )

/* Define window BEFORE current week */
VAR MeanStartDate = CurrentMaxDate - ( SelectedMeanWeeks * 7 )
VAR MeanEndDate = CurrentMaxDate - 1  /* Exclude current week */
VAR StdStartDate = CurrentMaxDate - ( SelectedStdWeeks * 7 )
VAR StdEndDate = CurrentMaxDate - 1

VAR CurrentItem = SELECTEDVALUE(parts[Item Description])
VAR CurrentFamily = SELECTEDVALUE(parts[Ultimate_family_name])

/* Summary for Mean - excludes current week */
VAR SummaryForMean =
    ADDCOLUMNS(
        CALCULATETABLE(
            SUMMARIZE(
                parts,
                parts[Order Fiscal Week],
                parts[Item Description],
                parts[Ultimate_family_name]
            ),
            parts[Item Description] = CurrentItem,
            parts[Ultimate_family_name] = CurrentFamily,
            parts[Order Date] >= MeanStartDate,
            parts[Order Date] <= MeanEndDate,
            parts[Order Fiscal Week] <> CurrentWeek  /* Extra safety */
        ),
        "NR_Value", [NR_Measure]
    )

/* Summary for StdDev - excludes current week */
VAR SummaryForStd =
    ADDCOLUMNS(
        CALCULATETABLE(
            SUMMARIZE(
                parts,
                parts[Order Fiscal Week],
                parts[Item Description],
                parts[Ultimate_family_name]
            ),
            parts[Item Description] = CurrentItem,
            parts[Ultimate_family_name] = CurrentFamily,
            parts[Order Date] >= StdStartDate,
            parts[Order Date] <= StdEndDate,
            parts[Order Fiscal Week] <> CurrentWeek  /* Extra safety */
        ),
        "NR_Value", [NR_Measure]
    )

VAR FilteredMean = FILTER(SummaryForMean, NOT ISBLANK([NR_Value]))
VAR FilteredStd = FILTER(SummaryForStd, NOT ISBLANK([NR_Value]))

VAR Mean = AVERAGEX(FilteredMean, [NR_Value])
VAR StdDevv = STDEVX.P(FilteredStd, [NR_Value])

RETURN
IF(
    NOT ISBLANK(Mean) && NOT ISBLANK(StdDevv),
    Mean + ( Multiplier * StdDevv ),
    BLANK()
)
