
CALCULATE(SUM(parts[Quantity Ordered]), ALLEXCEPT(parts, parts[Item Description], parts[Order Fiscal Week], parts[Ultimate_family_name]))

NR = DIVIDE([Weekly_qty_measure], parts[IB_fam],BLANK()) calculated column
Normal_rate = AVERAGE(parts[NR]) - translated into a measure

TrailingUpperLimit = 
VAR SelectedMeanWeeks = SELECTEDVALUE( ALERTWINDOWSELECTOR[TrailingWindow], 8 ) /* Default mean window i set is 2 years */
VAR SelectedStdWeeks  = SELECTEDVALUE( 'STDDEVIATION SELECTOR'[TrailingWindow], SelectedMeanWeeks )  // I am keeping this as a default fallback

VAR Multiplier = SELECTEDVALUE( StdDevSelector[Multiplier], 2 )

VAR MaxDate = CALCULATE(MAX(parts[Order Date]))

/* mean window start (mean selector) */
VAR MeanStartDate = MaxDate - ( SelectedMeanWeeks * 7 ) + 1

/* std window start (std selector) */
VAR StdStartDate = MaxDate - ( SelectedStdWeeks * 7 ) + 1

/* filtered table for mean (keeps the ALLEXCEPT logic for Item Description) */
VAR FilteredForMean =
    FILTER(
        ALLEXCEPT( Parts, Parts[Item Description], parts[Ultimate_family_name]), 
        Parts[Order Date] >= MeanStartDate
            && Parts[Order Date] <= MaxDate
            && NOT ISBLANK(parts[Normal_rate])
    )

/* filtered table for std (same scope but different date window) */
VAR FilteredForStd =
    FILTER(
        ALLEXCEPT( Parts, Parts[Item Description], parts[Ultimate_family_name]),
        Parts[Order Date] >= StdStartDate
            && Parts[Order Date] <= MaxDate
            && NOT ISBLANK(parts[Normal_rate])
    )

VAR Mean = CALCULATE(AVERAGEX(FilteredForMean, parts[Normal_rate]))
VAR StdDevv = CALCULATE(STDEVX.P(FilteredForStd, parts[Normal_rate]))

RETURN
Mean + ( Multiplier * StdDevv )

TrailingAnomaly = var normalrate = [Normal_rate]
VAR trailingupperlimit = [TrailingUpperLimit]
RETURN
IF(normalrate > trailingupperlimit,1,0)


TrailingUpperLimit = 
VAR SelectedMeanWeeks = SELECTEDVALUE( ALERTWINDOWSELECTOR[TrailingWindow], 8 )
VAR SelectedStdWeeks  = SELECTEDVALUE( 'STDDEVIATION SELECTOR'[TrailingWindow], SelectedMeanWeeks )
VAR Multiplier = SELECTEDVALUE( StdDevSelector[Multiplier], 2 )
VAR MaxDate = CALCULATE(MAX(parts[Order Date]))
VAR MeanStartDate = MaxDate - ( SelectedMeanWeeks * 7 ) + 1
VAR StdStartDate = MaxDate - ( SelectedStdWeeks * 7 ) + 1

/* Create a summary table of NR values for the mean window */
VAR SummaryForMean =
    CALCULATETABLE(
        SUMMARIZE(
            parts,
            parts[Order Fiscal Week],
            parts[Item Description],
            parts[Ultimate_family_name],
            "NR_Value", [NR_Measure]
        ),
        parts[Order Date] >= MeanStartDate,
        parts[Order Date] <= MaxDate,
        ALLEXCEPT(parts, parts[Item Description], parts[Ultimate_family_name])
    )

/* Create a summary table of NR values for the std window */
VAR SummaryForStd =
    CALCULATETABLE(
        SUMMARIZE(
            parts,
            parts[Order Fiscal Week],
            parts[Item Description],
            parts[Ultimate_family_name],
            "NR_Value", [NR_Measure]
        ),
        parts[Order Date] >= StdStartDate,
        parts[Order Date] <= MaxDate,
        ALLEXCEPT(parts, parts[Item Description], parts[Ultimate_family_name])
    )

/* Filter out blanks */
VAR FilteredMean = FILTER(SummaryForMean, NOT ISBLANK([NR_Value]))
VAR FilteredStd = FILTER(SummaryForStd, NOT ISBLANK([NR_Value]))

VAR Mean = AVERAGEX(FilteredMean, [NR_Value])
VAR StdDevv = STDEVX.P(FilteredStd, [NR_Value])

RETURN
Mean + ( Multiplier * StdDevv )
